# Release Process

This document describes the release process for Nexus maintainers.

## Overview

Nexus uses semantic versioning (SemVer) and automated release workflows.

```
v{MAJOR}.{MINOR}.{PATCH}[-{PRERELEASE}]

Examples:
- v0.5.0       - Stable release
- v0.5.1       - Patch release
- v0.6.0-alpha.1 - Pre-release
```

## Release Workflow

### 1. Prepare the Release

```bash
# Ensure you're on main with latest changes
git checkout main
git pull origin main

# Create a release branch
git checkout -b release/v0.X.Y
```

### 2. Update Version Numbers

Update version in all `Cargo.toml` files:

```bash
# Root workspace
sed -i '' 's/version = "0.X.Y"/version = "0.X.Z"/' Cargo.toml

# SDK
sed -i '' 's/version = "0.X.Y"/version = "0.X.Z"/' claude-code-sdk-rs/Cargo.toml

# API server
sed -i '' 's/version = "0.X.Y"/version = "0.X.Z"/' claude-code-api/Cargo.toml
```

### 3. Update Changelog

The changelog is auto-generated by git-cliff, but you can preview it:

```bash
git cliff --unreleased --tag v0.X.Z
```

### 4. Create and Push Tag

```bash
# Commit version changes
git add -A
git commit -m "chore(release): prepare v0.X.Z"

# Push release branch
git push origin release/v0.X.Z

# Create PR to main, wait for CI, then merge

# After merge, create tag on main
git checkout main
git pull origin main
git tag v0.X.Z
git push origin v0.X.Z
```

### 5. Automated Release

When the tag is pushed, GitHub Actions will automatically:

1. **Create GitHub Release** with changelog
2. **Build multi-platform binaries**:
   - Linux x64 and ARM64
   - macOS x64 and ARM64
   - Windows x64
3. **Upload artifacts** to the release
4. **Publish to crates.io**:
   - `nexus-claude` (SDK)
   - `claude-code-api` (API server)
5. **Update version branch** (e.g., `v0.5`)

## Pre-releases

For alpha, beta, or release candidates:

```bash
git tag v0.6.0-alpha.1
git push origin v0.6.0-alpha.1
```

Pre-releases are marked as such on GitHub and crates.io.

## Hotfix Process

For critical fixes to released versions:

```bash
# Checkout the version branch
git checkout v0.5
git pull origin v0.5

# Create hotfix branch
git checkout -b hotfix/v0.5.1

# Make fixes, then:
git commit -m "fix: critical security issue"
git push origin hotfix/v0.5.1

# Create PR to v0.5 branch
# After merge, tag the release
git checkout v0.5
git pull origin v0.5
git tag v0.5.1
git push origin v0.5.1

# Also merge to main if applicable
git checkout main
git merge v0.5
git push origin main
```

## Version Branches

After each minor release, a version branch is created:

- `v0.5` - Contains v0.5.0, v0.5.1, v0.5.2, etc.
- `v0.6` - Contains v0.6.0, v0.6.1, etc.

These branches receive hotfixes and are the base for patch releases.

## Troubleshooting

### crates.io Publication Failed

1. Check that `CARGO_REGISTRY_TOKEN` secret is valid
2. Verify version doesn't already exist on crates.io
3. Run `cargo publish --dry-run` locally

### Build Artifacts Missing

1. Check the release workflow logs
2. Verify cross-compilation toolchains are available
3. Re-run the workflow if transient failure

### Changelog Not Generated

1. Ensure commits follow conventional commit format
2. Check `cliff.toml` configuration
3. Verify git-cliff is installed in the workflow

## Checklist

Before releasing:

- [ ] All tests pass on CI
- [ ] Version numbers updated in all Cargo.toml files
- [ ] README and documentation updated if needed
- [ ] Breaking changes documented
- [ ] Migration guide written (if breaking)
- [ ] Changelog reviewed
